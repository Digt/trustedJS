<!DOCTYPE html>
<html>
    <head>
        <title>ASN decoder</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <style>
            *{
                font-family: Arial;
            }
            .caption{
                font-weight: bold;
                color:#999;
                text-align: right;
            }
            .label{
                font-weight: bold;
                color:#333;
                text-align: right;
            }
            td{
                padding:0px 5px;
            }
        </style>
        <script src="../trustedJS.js"></script>
        <script src="../test/js/fileReader.js"></script>

        <script src="../asn/asn.js"></script>

        <!-- PKI module -->
        <script src="src/schemas/rfc5280.js"></script>
        <script src="src/common.js"></script>
        <script src="src/oids.js"></script>
        <script src="src/crl.js"></script>
        <script src="src/extension.js"></script>
        <script src="src/algorithm.js"></script>
        <script src="src/key.js"></script>
        <script src="src/oid.js"></script>
        <script src="src/generalName.js"></script>
        <script src="src/extensions/crlExtensions.js"></script>
    </head>
    <body>
        <form style="display:none">
            <input id="file" type="file"  />
        </form>
        <div>
            <table id="CRLInfo"></table>
        </div>
        <script>
            function CRLInfo() {
                var el;
                this.__proto__.print = function(c, m) {
                    if (c === undefined)
                        c = '&nbsp;';
                    var tr = document.createElement("tr");
                    var tc = document.createElement("td");
                    tc.innerHTML = c;
                    if (m !== undefined) {
                        tc.setAttribute("class", "label");
                    }
                    else {
                        tc.setAttribute("class", "caption");
                        m = "&nbsp;";
                    }
                    var td = document.createElement("td");
                    td.innerHTML = m;
                    tr.appendChild(tc);
                    tr.appendChild(td);
                    el.appendChild(tr);
                };
                this.__proto__.clear = function() {
                    el.innerHTML = "";
                };
                function init() {
                    el = document.getElementById('CRLInfo');
                }
                init.call(this);
            }
            var info = new CRLInfo();
            window.fileLoaded = function(der) {

                info.clear();

                console.time("CRL import: ");
                var crl = new trusted.PKI.CRL(der);
                console.timeEnd("CRL import: ");

                info.print("CRL");
                info.print("Версия:", crl.version);
                info.print("Подпись:", crl.signatureAlgorithm.toString());
                info.print("Издатель:", crl.issuerName.toString());
                info.print("Последнее обновление:", crl.thisUpdate);
                info.print("Следующее обновление:", crl.nextUpdate);
                info.print("Подпись:", crl.signature);
                info.print("TBS:", Der.toHex(crl.TBSCertList));
                info.print();
                info.print("Расширения");
                info.print("Кол-во:", crl.extensions.length);
                for (var i = 0; i < crl.extensions.length; i++) {
                    info.print("#:", i + 1);
                    info.print("Расширение:", crl.extensions[i].OID.name);
                }
                info.print("Номер CRL:", crl.sequenceNumber);
                info.print();
                info.print("Сертификаты:");
                for (var i = 0; i < crl.certificates.length && i < 50; i++) {
                    info.print("#:", i + 1);
                    info.print("Серийный номер:", crl.certificates[i].serialNumber);
                    info.print("Дата отзыва:", crl.certificates[i].revocationDate);
                    info.print("Причина отзыва:", " (" + crl.certificates[i].reason + ") " + trusted.PKI.ReasonCode.reasonName(crl.certificates[i].reason));
                    info.print("Дата отмены:", crl.certificates[i].invalidityDate);
                    info.print("Имя издателя:", crl.certificates[i].issuerName);
                    info.print();
                }

                console.log(crl);
                console.log(crl.toObject());

            };

            var obj = {
                "tbsCertList":
                        {
                            version: 1,
                            signature:
                                    {
                                        "algorithm": "2.5.4.3",
                                        "parameters": Hex.toDer("0500")
                                    },
                            issuer:
                                    {
                                        "rdnSequence":
                                                [
                                                    [
                                                        {
                                                            "type": "2.5.4.6",
                                                            "value": Hex.toDer("13294D6963726F736F66742041757468656E7469636F646528746D2920526F6F7420417574686F72697479")
                                                        }
                                                    ]
                                                ]
                                    },
                            thisUpdate:
                                    {
                                        "generalTime": new Date("2014-07-22T12:58:10.000Z")
                                    },
                            revokedCertificates:
                                    [
                                        {
                                            "userCertificate": 192,
                                            "revocationDate":
                                                    {
                                                        "generalTime": new Date("2006-12-01T08:44:00.000Z")

                                                    },
                                            "crlEntryExtensions":
                                                    [
                                                        {
                                                            "critical": false,
                                                            "extnID": "2.5.29.21",
                                                            "extnValue": Hex.toDer("020105")
                                                        }
                                                    ]
                                        },
                                        {
                                            "userCertificate": 276,
                                            "revocationDate":
                                                    {
                                                        "generalTime": new Date("2012-09-04T10:14:22.000Z")
                                                    },
                                            "crlEntryExtensions":
                                                    [
                                                        {
                                                            "critical": false,
                                                            "extnID": "2.5.29.21",
                                                            "extnValue": Hex.toDer("020101")
                                                        }
                                                    ]
                                        }
                                    ],
                            crlExtensions:
                                    [
                                    ]
                        },
                signatureAlgorithm:
                        {
                            "algorithm": "2.5.29.1",
                            "parameters": Hex.toDer("0500")
                        },
                signatureValue:
                        {
                            "unusedBit": 0,
                            "encoded": Hex.toDer("02020301")
                        }
            };

            // CRL Extension
            var extnValue = 333;
            var asn = trusted.ASN.fromObject(extnValue, "BaseCRLNumber");


            var extn = {extnID: "2.5.29.27", critical: false, extnValue: asn.encode()};
            obj.tbsCertList.crlExtensions.push(extn);

            // CRL Extension
            var extnValue = {
                indirectCRL: true,
                onlyContainsUserCerts: true,
                distributionPoint: {fullName: [{uniformResourceIdentifier: "http://cdp.skbkontur.ru/cdp/kontur-ca3-2013.crl"}]}
            };
            var asn = trusted.ASN.fromObject(extnValue, "IssuingDistributionPoint");


            var extn = {extnID: "2.5.29.28", critical: false, extnValue: asn.encode()};
            obj.tbsCertList.crlExtensions.push(extn);

            var asn = trusted.ASN.fromObject(obj, "CertificateList");
            console.log(Base64.fromHex(Der.toHex(asn.encode())));
        </script>
    </body>
</html>
